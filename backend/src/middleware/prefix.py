from ..blueprints.messages.message import ErrorMessage


class PrefixMiddleware(object):
    """
    A middleware class for Flask, which configures it to prefix all endpoints
    with `/api`. For Any request it recieves without the prefix, it returns
    a 404 error.
    """

    def __init__(self, app, prefix=""):
        self.app = app
        self.prefix = prefix

    def __call__(self, environ, start_response):
        if environ["PATH_INFO"].startswith(self.prefix):
            environ["PATH_INFO"] = environ["PATH_INFO"][len(self.prefix) :]
            environ["SCRIPT_NAME"] = self.prefix
            return self.app(environ, start_response)
        else:
            start_response("404", [("Content-Type", "text/plain")])
            return (
                ErrorMessage(
                    "Not Found", "The requested URL is not on this server."
                ).to_dict(),
                404,
            )
